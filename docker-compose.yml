# ==============================================================================
# Agentic Fullstack Template - Development Environment
# ==============================================================================

services:
  # ----------------------------------------------------------------------------
  # PostgreSQL Database with PgVector
  # ----------------------------------------------------------------------------
  postgres:
    image: pgvector/pgvector:pg16
    container_name: agentic-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_DB: ${DB_APP_NAME:-agentic_db}
      DB_MIGRATION_USER: ${DB_MIGRATION_USER:-migration}
      DB_MIGRATION_PASSWORD: ${DB_MIGRATION_PASSWORD:-migration}
      DB_APP_USER: ${DB_APP_USER:-appuser}
      DB_APP_PASSWORD: ${DB_APP_PASSWORD:-appuser}
      DB_KEYCLOAK_USER: ${DB_KEYCLOAK_USER:-keycloak}
      DB_KEYCLOAK_PASSWORD: ${DB_KEYCLOAK_PASSWORD:-keycloak}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./docker/postgres/init-db.sh:/docker-entrypoint-initdb.d/init-db.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d ${DB_APP_NAME:-agentic_db}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ----------------------------------------------------------------------------
  # Keycloak Identity Provider
  # ----------------------------------------------------------------------------
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    container_name: agentic-keycloak
    restart: unless-stopped
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: ${KEYCLOAK_ADMIN:-admin}
      KC_BOOTSTRAP_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres:5432/${DB_APP_NAME:-agentic_db}?currentSchema=${DB_KEYCLOAK_SCHEMA:-keycloak}
      KC_DB_USERNAME: ${DB_KEYCLOAK_USER:-keycloak}
      KC_DB_PASSWORD: ${DB_KEYCLOAK_PASSWORD:-keycloak}
      KC_DB_SCHEMA: ${DB_KEYCLOAK_SCHEMA:-keycloak}
      KC_HTTP_ENABLED: true
      KC_HEALTH_ENABLED: true
      KC_METRICS_ENABLED: false
      KC_HOSTNAME: localhost
      KC_PROXY_HEADERS: xforwarded
      KC_HOSTNAME_STRICT: "false"
    ports:
      - "8080:8080"
    depends_on:
      postgres:
        condition: service_healthy
    command: start-dev
    healthcheck:
      test: ["CMD-SHELL", "exec 3<>/dev/tcp/127.0.0.1/8080;echo -e 'GET /health/ready HTTP/1.1\\r\\nhost: localhost\\r\\nConnection: close\\r\\n\\r\\n' >&3;if [ $? -eq 0 ]; then echo 'Healthcheck Successful';exit 0;else echo 'Healthcheck Failed';exit 1;fi;"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ----------------------------------------------------------------------------
  # Keycloak Setup (runs once to configure realm, client, and test user)
  # ----------------------------------------------------------------------------
  keycloak-setup:
    image: quay.io/keycloak/keycloak:26.0
    container_name: agentic-keycloak-setup
    environment:
      KEYCLOAK_URL: http://keycloak:8080
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      REALM_NAME: ${KEYCLOAK_REALM:-agentic}
      CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-agentic-app}
      CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-agentic-secret}
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
    volumes:
      - ./docker/keycloak/setup-realm.sh:/opt/setup-realm.sh:ro
    depends_on:
      keycloak:
        condition: service_healthy
    entrypoint: ["/bin/bash", "/opt/setup-realm.sh"]
    restart: "no"

  # ----------------------------------------------------------------------------
  # Backend (Agno + FastAPI)
  # ----------------------------------------------------------------------------
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: agentic-backend
    restart: unless-stopped
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      ENVIRONMENT: ${ENVIRONMENT:-dev}
      AI_PROVIDER: ${AI_PROVIDER:-openai}
      AI_URL: ${AI_URL:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      GOOGLE_API_KEY: ${GOOGLE_API_KEY:-}
      MISTRAL_API_KEY: ${MISTRAL_API_KEY:-}
      DB_APP_HOST: postgres
      DB_APP_PORT: 5432
      DB_APP_NAME: ${DB_APP_NAME:-agentic_db}
      DB_APP_SCHEMA: ${DB_APP_SCHEMA:-app}
      DB_APP_USER: ${DB_APP_USER:-appuser}
      DB_APP_PASSWORD: ${DB_APP_PASSWORD:-appuser}
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./backend:/app
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  postgres_data:
    name: agentic-postgres-data
